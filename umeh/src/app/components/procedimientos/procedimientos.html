<div class="tabla-container">
  <div style="display:flex; align-items:center; gap:12px; margin-bottom: 12px;">
    <h2 style="margin:0; flex: 0 0 auto;">Procedimientos</h2>
    <div style="flex: 1 1 auto;"></div>
    <div class="input-with-icon" style="flex:0 0 320px; max-width: 50%;">
      <i class="fa-solid fa-magnifying-glass"></i>
      <input type="text" [(ngModel)]="searchTerm" (ngModelChange)="onSearchTermChange()"
        placeholder="Buscar por procedimiento, responsable o insumo..."
        style="width:100%; padding:8px 8px 8px 32px; border-radius:8px; border:1px solid var(--input-border);" />
    </div>
  </div>

  <p-toast [showTransitionOptions]="'250ms'" [showTransformOptions]="'translateX(100%)'"
    [hideTransitionOptions]="'150ms'" [hideTransformOptions]="'translateX(100%)'" />

  <div class="table-scroll">
    <table class="procedimiento-table">
      <thead>
        <tr>
          <th (click)="toggleSort('procedimiento')" style="cursor:pointer; user-select:none;">
            Procedimiento
            <span *ngIf="sortColumn==='procedimiento'" aria-hidden="true">{{ sortDirection === 'asc' ? '‚ñ≤' : '‚ñº'
              }}</span>
          </th>
          <th>Observaciones</th>
          <th>Insumos</th>
          <th>Responsables</th>
          <th (click)="toggleSort('costo_total')" style="cursor:pointer; user-select:none;">
            Costo Total
            <span *ngIf="sortColumn==='costo_total'" aria-hidden="true">{{ sortDirection === 'asc' ? '‚ñ≤' : '‚ñº' }}</span>
          </th>
          <th class="actions">Acciones</th>
        </tr>
      </thead>
      <tbody>
        <ng-container *ngIf="loading; else dataRows">
          <tr *ngFor="let _ of loadingRows">
            <td><p-skeleton></p-skeleton></td>
            <td><p-skeleton></p-skeleton></td>
            <td><p-skeleton></p-skeleton></td>
            <td><p-skeleton></p-skeleton></td>
            <td><p-skeleton></p-skeleton></td>
            <td class="actions"><p-skeleton></p-skeleton></td>
          </tr>
        </ng-container>

        <ng-template #dataRows>
          <tr *ngIf="procedimientosView.length === 0">
            <td colspan="6" style="text-align:center; opacity:0.8; padding:20px;">
              {{ searchTerm ? 'No se encontraron procedimientos que coincidan con la b√∫squeda.' : 'No hay procedimientos
              registrados.' }}
            </td>
          </tr>
          <tr *ngFor="let p of procedimientosView">
            <td>
              <div>{{ p.procedimiento }}</div>
            </td>
            <td>
              <span *ngIf="p.observaciones; else noObservaciones" class="text-muted">
                {{ p.observaciones }}
              </span>
              <ng-template #noObservaciones>
                <span class="text-muted">N/A</span>
              </ng-template>
            </td>
            <td>
              <div class="cell-list" *ngIf="p.insumos_detalle?.length; else noInsumos">
                <ul>
                  <li *ngFor="let i of p.insumos_detalle">
                    <span>{{ i.insumo }}</span>
                    <span>
                      <span class="badge">{{ i.tipo }}</span>
                      {{ i.cantidad }}
                    </span>
                  </li>
                </ul>
              </div>
              <ng-template #noInsumos>
                <span class="text-muted">Sin insumos</span>
              </ng-template>
            </td>
            <td>
              <div class="cell-list" *ngIf="p.costos_detalle?.length; else noCostos">
                <ul>
                  <li *ngFor="let c of p.costos_detalle">
                    <span>{{ c.responsable }}</span>
                    <span>{{ c.costo | currency:'MXN':'symbol-narrow':'1.2-2' }}</span>
                  </li>
                </ul>
              </div>
              <ng-template #noCostos>
                <span class="text-muted">Sin responsables</span>
              </ng-template>
            </td>
            <td style="font-weight: 600; color: var(--primary-color);">
              {{ (p.costo_total || 0) | currency:'MXN':'symbol-narrow':'1.2-2' }}
            </td>
            <td class="actions">
              <button class="action-btnP" (click)="openEdit(p)" title="Editar procedimiento">
                <img src="assets/img/edit.png" class="btn-iconP" alt="Editar">
              </button>
              <button class="action-btnP" (click)="confirmarEliminacion(p)" title="Eliminar procedimiento">
                <img src="assets/img/delet.png" class="btn-iconP" alt="Eliminar">
              </button>
            </td>
          </tr>
        </ng-template>
      </tbody>
    </table>
  </div>

  <!-- Modal de Edici√≥n -->
  <div *ngIf="modalEditOpen" class="modal-overlay" (click)="closeEdit()">
    <div class="modal-content large-modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Editar Procedimiento</h2>
        <button class="modal-close" (click)="closeEdit()">√ó</button>
      </div>

      <div class="modal-body">
        <form [formGroup]="editForm" class="proc-grid full-row">
          <div class="form-field">
            <label>Descripci√≥n <span class="requerido">*</span></label>
            <input type="text" formControlName="descripcion" placeholder="Describe el procedimiento" />
          </div>
          <div class="form-field">
            <label>Notas adicionales</label>
            <input type="text" formControlName="observaciones" placeholder="Notas adicionales" />
          </div>

          <!-- Responsables -->
          <div class="two-col full-row">
            <div>
              <h3>Responsables y Costos <span class="requerido">*</span></h3>
              <div formArrayName="responsables">
                <div class="form-field inline" *ngFor="let r of responsablesFA.controls; let i = index"
                  [formGroupName]="i">
                  <p-select [options]="[
                    {label: 'UMEH', value: 'UMEH'},
                    {label: 'ENFERMERO', value: 'ENFERMERO'},
                    {label: 'MEDICO', value: 'MEDICO'}
                  ]" formControlName="nombre" />
                  <input type="number" formControlName="costo" placeholder="Costo" />
                  <button type="button" class="deleteButton" (click)="removeResponsable(i)">
                    üóëÔ∏è
                    <span class="tooltip">Eliminar</span>
                  </button>
                </div>
                <button type="button" (click)="addResponsable()" class="add-btn">+ Agregar Responsable</button>
              </div>
            </div>
            <div>
              <h4>Resumen de Responsables</h4>
              <ul class="summary-list">
                <li *ngFor="let r of responsablesFA.controls">
                  <span>{{ r.value.nombre }}</span>
                  <span>{{ r.value.costo | currency }}</span>
                </li>
              </ul>
              <div class="total-cost">
                <strong>Total:</strong> {{ costoTotal | currency }}
              </div>
            </div>
          </div>

          <!-- Insumos -->
          <div class="two-col full-row">
            <div>
              <h3>Insumos utilizados</h3>
              <div formArrayName="insumos">
                <div class="form-field inline" *ngFor="let ins of insumosFA.controls; let i = index"
                  [formGroupName]="i">
                  <!-- B√∫squeda por teclado con datalist -->
                  <input type="text" placeholder="Buscar insumo..." formControlName="busqueda" list="listaInsumos"
                    (change)="onSearchInsumo(i)" />
                  <datalist id="listaInsumos">
                    <option *ngFor="let m of medicamentos" [value]="m.nombre"></option>
                    <option *ngFor="let t of materiales" [value]="t.nombre"></option>
                    <option *ngFor="let g of matGenerales" [value]="g.nombre"></option>
                  </datalist>
                  <!-- Select opcional para selecci√≥n directa -->
                  <select formControlName="encoded" (change)="onSelectInsumo(i)">
                    <option [ngValue]="null">-- Selecciona --</option>
                    <optgroup label="Medicamentos">
                      <option *ngFor="let m of medicamentos" [value]="'med-'+m.id">{{ m.nombre }} (Disp: {{ m.cantidad
                        }})
                      </option>
                    </optgroup>
                    <optgroup label="Material TRIAGE">
                      <option *ngFor="let t of materiales" [value]="'mat-'+t.id">{{ t.nombre }} (Disp: {{ t.cantidad }})
                      </option>
                    </optgroup>
                    <optgroup label="Material General">
                      <option *ngFor="let g of matGenerales" [value]="'mg-'+g.id">{{ g.nombre }} (Disp: {{ g.cantidad
                        }})
                      </option>
                    </optgroup>
                  </select>
                  <input type="number" min="0" formControlName="cantidad" placeholder="Cantidad"
                    (change)="onCantidadChange(i)" />
                  <button type="button" class="deleteButton" (click)="removeInsumo(i)">
                    üóëÔ∏è
                    <span class="tooltip">Eliminar</span>
                  </button>
                </div>
                <button type="button" (click)="addInsumo()">+ Agregar Insumo</button>
              </div>
            </div>
            <div>
              <h4>Resumen de Insumos</h4>
              <ul class="summary-list">
                <li *ngFor="let ins of insumosFA.controls">
                  <span>{{ ins.value.nombre || '‚Äî' }}</span>
                  <span>x {{ ins.value.cantidad || 0 }}</span>
                </li>
              </ul>
            </div>
          </div>
        </form>
      </div>

      <div class="modal-actions">
        <button class="btn-cancel" (click)="closeEdit()">Cancelar</button>
        <button class="btn-save" (click)="saveEdit()">Guardar Cambios</button>
      </div>
    </div>
  </div>

  <!-- Modal de Confirmaci√≥n de Eliminaci√≥n -->
  <div class="modal-overlay" *ngIf="modalEliminarVisible" (click)="cancelarEliminacion()">
    <div class="modal-content danger-modal" (click)="$event.stopPropagation()">
      <div class="danger-icon-circle">
        <i class="fa-regular fa-trash-can"></i>
      </div>

      <h2 class="danger-title">¬øEliminar Procedimiento?</h2>

      <p class="danger-message">
        Est√°s a punto de eliminar el procedimiento <strong>{{ procedimientoAEliminar?.procedimiento }}</strong> de forma
        permanente.
        <br>Esta acci√≥n <b>no se puede deshacer</b> y tambi√©n eliminar√° todos los insumos y responsables asociados.
      </p>

      <div class="modal-actions centered">
        <button class="btn-cancel" (click)="cancelarEliminacion()">Cancelar</button>
        <button class="btn-delete-confirm" (click)="ejecutarEliminacion()">S√≠, eliminar</button>
      </div>
    </div>
  </div>
</div>