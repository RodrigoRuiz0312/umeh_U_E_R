<div class="card">
  <div *ngIf="!agendaSeleccionada" class="seleccion_container">
    <div class="card-header">
       <h2>Agendación de citas</h2>
    </div>

    <div class="buscador general">
      <h3>Buscar cita existente</h3>
      <input class="input-name"type="text" placeholder="Escriba nombre del paciente..."
      [(ngModel)]="terminoBusquedaCita" (keyup)="buscarCitas()">

      <div class="resultados-busqueda" *ngIf="resultadoBusqueda.length > 0">
        <div *ngFor="let cita of resultadoBusqueda" class="resultado-item">
          <p><strong>Paciente:</strong> {{ cita.nombre_paciente }} {{cita.apellidos_paciente }}</p>
          <p><strong>Médico:</strong> {{ cita.nombre_medico }}</p>
          <p><strong>Fecha:</strong> {{ cita.fecha | date:'dd/MM/yyyy' }} - {{ cita.hora.substring(0, 5) }} hrs</p>
          <p><strong>Consultorio:</strong> {{ cita.consultorio }}</p>
        </div>
      </div>
    </div>

    <div class="agendas-wrapper">
      <div class="agenda-cover general" (click)="seleccionarAgenda('General')">
        <div class="agenda-title">Agenda General</div>
      </div>

      <div class="agenda-cover neuropediatra" (click)="seleccionarAgenda('Neuropediatra')">
        <div class="agenda-title">Agenda Neuropediatra</div>
      </div>

      <div class="agenda-cover cirujano" (click)="seleccionarAgenda('Cirujano')"> 
        <div class="agenda-title">Agenda Cirujano</div>
      </div>
    </div>
  </div>

  <div *ngIf="agendaSeleccionada" class="tablero-container">
    <h2>Agenda: {{ agendaSeleccionada | titlecase }}</h2>
    
    <div class="date-selector">
      <label for="fecha"> Selecciona la fecha:</label>
      <input type="date" id="fecha" [(ngModel)]="fechaSeleccionada" (change)="cargarAgenda()">
    </div>

    <div class="board">
      <div class="doctor-column" *ngFor="let doctor of agenda">
        <div class="doctor-header">
          <h3>{{ doctor.nombre }} {{ doctor.apellidos }}</h3>
        </div>

        <div class="time-slots">
          <div *ngFor="let par of horariosDelDia" class="time-slot-row">
            
            <button
              class="time-slot"
              [class.ocupado]="isHourBooked(doctor, par.h1)"
              (click)="isHourBooked(doctor, par.h1) ? verDetallesCita(getAppointmentForHour(doctor, par.h1)) : abrirModalAgendar(doctor, par.h1)">
              
              <span *ngIf="!isHourBooked(doctor, par.h1)">
                {{ par.h1.substring(0, 5) }} hrs
              </span>
              <span *ngIf="isHourBooked(doctor, par.h1)">
                <strong>Ocupado</strong>
                </span>
            </button>
            
            <button
              *ngIf="par.h2"
              class="time-slot"
              [class.ocupado]="isHourBooked(doctor, par.h2)"
              (click)="isHourBooked(doctor, par.h2) ? verDetallesCita(getAppointmentForHour(doctor, par.h2)) : abrirModalAgendar(doctor, par.h2)">
              
              <span *ngIf="!isHourBooked(doctor, par.h2)">
                {{ par.h2.substring(0, 5) }} hrs
              </span>
              <span *ngIf="isHourBooked(doctor, par.h2)">
                <strong>Ocupado</strong>
                </span>
            </button>

            <div *ngIf="!par.h2" class="time-slot-placeholder"></div>
            
          </div>
        </div>
      </div>
    </div>
    
    <button class='btn btn-primary' (click)="volverASeleccion()">&lt; Volver a seleccionar agenda</button>
  </div>
  
</div>

<app-agendar-cita-modal
  *ngIf="isAgendarModalVisible"
  [datosCita]="datosParaNuevaCita"
  (close)="cerrarModalAgendar()"
  (citaCreada)="citaAgendadaConExito()">
</app-agendar-cita-modal>

<app-detalles-cita-modal
  *ngIf="isDetailsModalVisible"
  [cita]="citaSeleccionada"
  (close)="closeDetailsModal()"
  (citaActualizada)="citaActualizadaConExito()"> 
</app-detalles-cita-modal>