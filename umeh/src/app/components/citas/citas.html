<p-toast></p-toast>

<div class="card">
  <div *ngIf="!agendaSeleccionada" class="dashboard-container">

    <div class="header-section">
      <h2>Bienvenido al Gestor de Citas</h2>
      <p class="subtitle">Seleccione una agenda o busque una cita existente</p>
    </div>

    <div class="search-section">
      <div class="search-input-wrapper">
        <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
          stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
        </svg>
        <input type="text" placeholder="Buscar por nombre del paciente..." [(ngModel)]="terminoBusquedaCita"
          (keyup)="buscarCitas()">
      </div>

      <div class="search-results-container" *ngIf="resultadoBusqueda.length > 0">
        <div class="results-header">Resultados encontrados ({{resultadoBusqueda.length}})</div>
        <div *ngFor="let cita of resultadoBusqueda" class="result-card">
          <div class="result-info">
            <div class="patient-name">{{ cita.nombre_paciente }} {{cita.apellidos_paciente }}</div>
            <div class="meta-info">
              <span><strong>Fecha:</strong> {{ cita.fecha | date:'dd/MM/yyyy' }}</span>
              <span><strong>Hora:</strong> {{ cita.hora.substring(0, 5) }} hrs</span>
              <span><strong>MÃ©dico(a):</strong> {{ cita.nombre_medico }} {{cita.apellidos_medico}}</span>
            </div>
          </div>
          <div class="result-action">
            <span class="consultorio-badge">{{ cita.consultorio }}</span>
          </div>
        </div>
      </div>

      <div class="no-results" *ngIf="haRealizadoBusqueda && resultadoBusqueda.length === 0">
        <p>ðŸš« No se encontraron citas para "<strong>{{terminoBusquedaCita}}</strong>"</p>
      </div>
    </div>

    <hr class="divider">

    <h3>Seleccionar Agenda</h3>
    <div class="agendas-grid">

      <div class="agenda-card general" (click)="seleccionarAgenda('General')">
        <div class="icon-circle">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
          </svg>
        </div>
        <h4>Agenda General</h4>
        <span class="link-text">Abrir agenda &rarr;</span>
      </div>

      <div class="agenda-card neuro" (click)="seleccionarAgenda('Neuropediatra')">
        <div class="icon-circle">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
          </svg>
        </div>
        <h4>NeuropediatrÃ­a</h4>
        <span class="link-text">Abrir agenda &rarr;</span>
      </div>

      <div class="agenda-card cirujano" (click)="seleccionarAgenda('Cirujano')">
        <div class="icon-circle">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M14.121 14.121L19 19m-7-7l7-7m-7 7l-2.879 2.879M12 12L9.121 9.121m0 5.758a3 3 0 10-4.243 4.243 3 3 0 004.243-4.243zm0-5.758a3 3 0 10-4.243-4.243 3 3 0 004.243 4.243z" />
          </svg>
        </div>
        <h4>Cirujano</h4>
        <span class="link-text">Abrir agenda &rarr;</span>
      </div>
    </div>

  </div>

  <div *ngIf="agendaSeleccionada" class="tablero-container">

    <div class="tablero-header">
      <div class="titles">
        <h2>{{ agendaSeleccionada }}</h2>
        <p class="subtitle-doc">Vista Global Diaria</p>
      </div>

      <div class="date-selector">
        <label for="fecha">Fecha de consulta:</label>
        <input type="date" id="fecha" [(ngModel)]="fechaSeleccionada" (change)="cargarAgenda()">
      </div>
    </div>

    <hr class="divider-light">

    <div class="board-wrapper">
      <div class="board">
        <!-- Iterar Consultorios en lugar de Doctores -->
        <div class="doctor-column" *ngFor="let consultorio of consultorios">

          <div class="doctor-header">
            <h3>{{ consultorio }}</h3>
          </div>

          <div class="time-slots-wrapper">
            <h4 class="time-group-header">MaÃ±ana</h4>
            <div class="pills-container">
              <button *ngFor="let horario of horariosManana" class="time-pill"
                [class.ocupado]="getCitaCelda(consultorio, horario)"
                (click)="abrirModalAgendarCelda(consultorio, horario)">

                <span *ngIf="!getCitaCelda(consultorio, horario)">{{ horario.substring(0, 5) }}</span>

                <div *ngIf="getCitaCelda(consultorio, horario)" class="cita-preview">
                  <span class="pill-time-mini">{{ horario.substring(0, 5) }}</span>
                  <div class="pill-stack patient-stack">
                    <span class="text-upper">{{ getCitaCelda(consultorio, horario).nombre_paciente }}</span>
                    <span class="text-upper">{{ getCitaCelda(consultorio, horario).apellidos_paciente }}</span>
                  </div>
                  <div class="pill-stack doctor-stack" *ngIf="getCitaCelda(consultorio, horario).apellidos_medico">
                    <span class="doc-label">Dr(a). {{ getCitaCelda(consultorio, horario).nombre_medico }}</span>
                    <span class="doc-surname">{{ getCitaCelda(consultorio, horario).apellidos_medico }}</span>
                  </div>
                </div>
              </button>
            </div>

            <h4 class="time-group-header">Tarde</h4>
            <div class="pills-container">
              <button *ngFor="let horario of horariosTarde" class="time-pill"
                [class.ocupado]="getCitaCelda(consultorio, horario)"
                (click)="abrirModalAgendarCelda(consultorio, horario)">

                <span *ngIf="!getCitaCelda(consultorio, horario)">{{ horario.substring(0, 5) }}</span>

                <div *ngIf="getCitaCelda(consultorio, horario)" class="cita-preview">
                  <span class="pill-time-mini">{{ horario.substring(0, 5) }}</span>
                  <div class="pill-stack patient-stack">
                    <span class="text-upper">{{ getCitaCelda(consultorio, horario).nombre_paciente }}</span>
                    <span class="text-upper">{{ getCitaCelda(consultorio, horario).apellidos_paciente }}</span>
                  </div>
                  <div class="pill-stack doctor-stack" *ngIf="getCitaCelda(consultorio, horario).apellidos_medico">
                    <span class="doc-label">Dr(a). {{ getCitaCelda(consultorio, horario).nombre_medico }}</span>
                    <span class="doc-surname">{{ getCitaCelda(consultorio, horario).apellidos_medico }}</span>
                  </div>
                </div>
              </button>
            </div>
          </div>
        </div>
      </div>

      <div class="actions-footer">
        <button class='btn btn-reg' (click)="volverASeleccion()">
          &lt; Cambiar Agenda
        </button>
      </div>

    </div>
  </div>

</div>

<app-agendar-cita-modal *ngIf="isAgendarModalVisible" [datosCita]="datosParaNuevaCita" (close)="cerrarModalAgendar()"
  (citaCreada)="citaAgendadaConExito()">
</app-agendar-cita-modal>

<app-detalles-cita-modal *ngIf="isDetailsModalVisible" [cita]="citaSeleccionada" (close)="closeDetailsModal()"
  (citaActualizada)="citaActualizadaConExito()">
</app-detalles-cita-modal>